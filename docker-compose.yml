version: "3.8"

services:
  # ---------------------------------------------------------
  # 1. Loki (Log Aggregator)
  # ---------------------------------------------------------
  loki:
    image: grafana/loki:2.9.1
    container_name: loki
    command: -config.file=/etc/loki/loki-config.yaml
    user: "10001:10001"
    volumes:
      - ./loki/loki-config.yaml:/etc/loki/loki-config.yaml:ro
      - loki-data:/loki
    ports:
      - "3100:3100"
    restart: unless-stopped

  # ---------------------------------------------------------
  # 2. Promtail (Log Collector)
  # ---------------------------------------------------------
  promtail:
    image: grafana/promtail:2.9.1
    container_name: promtail
    volumes:
      - ./promtail/promtail-config.yml:/etc/promtail/config.yml:ro
      - ./app/log:/var/log/app
    command: -config.file=/etc/promtail/config.yml
    depends_on:
      - loki
    restart: always

  # ---------------------------------------------------------
  # 3. App (Log Generator)
  # ---------------------------------------------------------
  app:
    build: ./app
    container_name: log_generator_app
    volumes:
      - ./app/log:/var/log/app
    depends_on:
      - promtail
    restart: always

  # ---------------------------------------------------------
  # 4. Detector (AI anomaly detection + remediation)
  # ---------------------------------------------------------
  detector:
    build: ./detector
    container_name: anomaly_detector
    env_file:
      - .env   # load all secrets
    environment:
      - LOKI_URL=${LOKI_URL}
      - LOG_QUERY_RANGE_MINUTES=${LOG_QUERY_RANGE_MINUTES}
      - WINDOW_SIZE=${WINDOW_SIZE}
      - WINDOW_STEP=${WINDOW_STEP}
      - CONTAMINATION=${CONTAMINATION}
      - SLACK_WEBHOOK=${SLACK_WEBHOOK}
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - GITHUB_REPO=${GITHUB_REPO}
    depends_on:
      - loki
      - app
    restart: on-failure

  # ---------------------------------------------------------
  # 5. Grafana (Dashboards)
  # ---------------------------------------------------------
  grafana:
    image: grafana/grafana:10.2.3
    container_name: grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - grafana-data:/var/lib/grafana
    depends_on:
      - loki
    restart: unless-stopped

# -------------------------------------------------------------
# VOLUMES
# -------------------------------------------------------------
volumes:
  loki-data:
  grafana-data:
